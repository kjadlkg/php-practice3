# **File_Download_Vulnerability**

: 웹 애플리케이션에서 파일을 다운로드할 때 적절한 검증이 이루어지지 않아 공격자가 임의의 파일을 다운로드할 수 있는 보안 취약점을 의미

이 취약점을 악용하면 공격자가 웹 서버에 존재하는 환경 설정 파일, DB 정보 파일 등의 민감한 파일을 다운로드할 수 있다.

이 취약점은 **소스코드를 다운로드**할 수 있다는 점이 주요 문제이다.
소스코드를 확인해서 DB 정보 등 중요 정보를 탈취할 수 있을 뿐만 아니라 웹 서버에 존재하는 또 다른 취약점을 쉽게 발견할 수 있다.

<br>
<br>

## **공격의 종류**

파일 다운로드 취약점은 주로 **Directory Traversal 공격**을 통해 이루어진다.

### 1. Directory Traversal 공격

: 공격자가 `../` 등의 경로 탐색 문자를 사용하여 원래 다운로드할 수 없는 파일에 접근

```bash
http://example.com/download.php?file=../../../../etc/passwd
```

위와 같은 요청이 허용되면 사용자 계정 정보를 포함한 리눅스 시스템의 `/etc/passwd` 파일을 다운로드할 수 있다.

<br>

### 2. NULL Byte Injection 공격

: PHP 등의 일부 환경에서는 `%00`(널 바이트)를 이용해 확장자 검증을 우회

```perl
http://example.com/download.php?file=config.php%00.jpg
```

만약 서버가 `.jpg` 파일만 허용하도록 되어 있어도, `%00` 이후의 확장자를 무시하는 경우 `config.php`를 그대로 다운로드할 수 있다.

<br>
<br>

## **공격 시나리오**

취약한 코드 예시:

```php
<?php
$filename = $_GET['file'];
$filepath = "uploads/" . $filename;

if (file_exists($filepath)) {
    header("Content-Disposition: attachment; filename=" . basename($filepath));
    readfile($filepath);
} else {
    echo "파일이 존재하지 않습니다.";
}
?>
```

문제점:

- `file` 파라미터를 검증하지 않고 그대로 사용
- 공격자가 `../../../../etc/passwd`와 같은 값을 입력하면 서버 내부 파일 다운로드 가능

공격 예시:
공격자가 다음과 같은 요청을 보낸 경우

```bash
http://example.com/download.php?file=../../../../etc/passwd
```

만약 서버가 리눅스 환경이라면 `/etc/passwd` 파일을 다운로드하여 사용자 계정 정보를 얻을 수 있다.

<br>
<br>

## **방어 방법**

### 1. 사용자 입력값 검증 및 화이트리스트 적용

- 허용된 파일 확장자 및 경로만 다운로드 가능하도록 제한한다
- 특정한 파일만 다운로드 가능하도록 설정한다.

```php
<?php
$allowed_files = ["safe_document.pdf", "user_guide.txt"];
$filename = $_GET['file'];

if (!in_array($filename, $allowed_files)) {
    die("허용되지 않은 파일입니다.");
}

$filepath = "uploads/" . $filename;
if (file_exists($filepath)) {
    header("Content-Disposition: attachment; filename=" . basename($filepath));
    readfile($filepath);
} else {
    echo "파일이 존재하지 않습니다.";
}
?>
```

<br>

### 2. 디렉토리 트래버설 방지

- `basename()` 함수를 이용하여 경로 탐색 `../`를 제거한다.

```php
<?php
$filename = basename($_GET['file']); // 경로 탐색 문자 제거
$filepath = "uploads/" . $filename;

if (file_exists($filepath)) {
    header("Content-Disposition: attachment; filename=" . basename($filepath));
    readfile($filepath);
} else {
    echo "파일이 존재하지 않습니다.";
}
?>
```

<br>

### 3. 널 바이트 공격 방어 (확장자 검사 강화)

```php
<?php
$filename = basename($_GET['file']);
$filepath = "uploads/" . $filename;

if (file_exists($filepath)) {
    header("Content-Disposition: attachment; filename=" . basename($filepath));
    readfile($filepath);
} else {
    echo "파일이 존재하지 않습니다.";
}
?>
```

- `strpos($filename, "\0") !== false` → 널 바이트 포함 여부 확인
- `preg_match("/^[a-zA-Z0-9_.-]+$/", $filename])` → 파일명에 허용된 문자만 포함

<br>

### 4. 서버 권한 설정

- 웹 서버가 민감한 파일(`config.php`, `.env` 등)에 접근할 수 없도록 설정한다.
- 다운로드 디렉토리를 웹 루트 외부에 배치하여 직접 접근을 방지한다.

<br>

### 5. MIME 타입 검사

- 서버에서 다운로드할 파일의 MIME 타입을 검사하여 예상된 파일만 전송한다.

```php
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mime = finfo_file($finfo, $filepath);
finfo_close($finfo);

$allowed_mimes = ["application/pdf", "text/plain"];
if (!in_array($mime, $allowed_mimes)) {
    die("잘못된 파일 형식입니다.");
}
```
