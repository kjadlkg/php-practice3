# **File_Upload_Vulnerability**

: 웹 애플리케이션에서 파일을 업로드할 수 있는 기능이 적절하게 검증되지 않을 때 발생하는 보안 취약점

웹 페이지의 파일 업로드 기능을 이용해서 공격자가 원하는 임의의 파일을 업로드할 수 있다.

공격자는 서버 측 스크립트(`.php`, `.asp`, `.jsp`)를 이용해서 웹쉘을 제작하여 업로드한다. 이를 이용하여 서버에 침투하여 권한을 상승하고 서버를 장악할 수 있다.

**발생 원인**은 서버에서 파일을 업로드 받을 때 확장자를 검증하지 않아 발생한다.

**발생 위치**는 파일을 업로드할 수 있는 모든 곳에서 발생하며
이 공격의 가장 큰 핵심은 서버에 공격자가 원하는 코드를 실행할 수 있다는 점이다.

그러기 위해서는

- 웹 서버 측 실행 코드를 업로드
  : 서버 측 실행코드를 아는 것이 우선이다.
  php 서버라면 php 파일로, jsp 서버라면 jsp 파일로 웹쉘을 제작해서 업로드해야 서버에서 실행 가능하다.

- 업로드 된 파일의 경로 파악
  : 파일을 업로드하고 끝이 아니라 서버에서 실행되게 해야한다.
  요청을 보내야 서버 측에서 실행되기 때문에 업로드한 파일의 경로를 알고 접근해야 한다.

<br>
<br>

## **공격의 종류**

### 1. Web Shell Upload, 웹쉘 업로드

: 공격자가 `.php`, `.asp`, `.jsp`등의 스크립트 파일을 업로드하여 서버에서 원격으로 명령을 실행하는 공격 방식

```php
<?php system($_GET['cmd']); ?>
```

공격자는 `http://example.com/uploads/evil.php?cmd=whoami` 와 같은 URL을 실행해 서버에서 명령을 실행할 수 있다.

<br>

### 2. Client-side Bypass, 클라이언트 측 우회 공격

: 웹 프론트엔드에서 파일 확장자를 필터링하지만, 공격자가 개발자 도구나 프록시를 이용해 필터링을 우회하는 경우이다.

예를 들면, `.php` 파일 업로드가 차단된 경우, `.php.jpg`로 변조 후 업로드한다.

<br>

### 3. MIME 타입 우회

: 웹 애플리케이션이 파일의 MIME 타입만 검사하는 경우, 공격자는 HTTP 요청을 변조하여 허용된 이미지 MIME 타입(`image/png`)을 사용하면서 실제로는 PHP 코드가 포함된 파일을 업로드할 수 있다.

<br>

### 4. Directory Traversal, 디렉터리 트래버설

: 업로드된 파일의 저장 경로가 제대로 검증되지 않으면 공격자는 파일을 원하는 위치에 업로드할 수 있다.

예를 들어, `../../../var/www/html/shell.php` 형태로 경로를 조작하여 중요한 시스템 파일을 덮어쓸 수도 있다.

<br>

### 5. Denial of Service (DoS), 대량 파일 업로드

: 서버에 너무 많은 파일을 업로드하여 디스크 공간을 고갈시키는 공격

<br>
<br>

## **방어 방법**

### 1. 업로드 파일 검증

#### 파일 확장자 제한

서버에서 허용된 확장자만 업로드할 수 있도록 제한한다.

PHP에서는 `in_array()`를 사용하여 허용된 확장자만 업로드 가능하도록 설정한다.

```php
$allowed_extensions = ['jpg', 'png', 'gif'];
$file_extension = pathinfo($_FILES['upload']['name'], PATHINFO_EXTENSION);

if (!in_array($file_extension, $allowed_extensions)) {
    die("허용되지 않은 파일 형식입니다.");
}
```

<br>

#### MIME 타입 검사

클라이언트가 변조할 수 없는 `finfo_file()` 함수를 사용하여 실제 MIME 타입을 확인한다.

```php
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mime = finfo_file($finfo, $_FILES['upload']['tmp_name']);
finfo_close($finfo);

if (!in_array($mime, ['image/jpeg', 'image/png', 'image/gif'])) {
    die("허용되지 않은 파일 형식입니다.");
}
```

<br>

### 2. 업로드 파일 실행 방지

#### 업로드된 파일을 실행되지 않는 디렉터리에 저장

웹 서버에서 실행되지 않는 폴더를 만들어서 업로드 파일을 저장하고, 아래와 같이 `.htaccess`를 추가하여 실행을 차단한다.

```sql
# .htaccess 설정 (Apache의 경우)
<FilesMatch "\.(php|jsp|asp|exe|sh)$">
    Deny from all
</FilesMatch>
```

```nginx
// Nginx 설정
location /uploads/ {
    location ~* \.(php|jsp|asp|exe|sh)$ {
        deny all;
    }
}
```

<br>

### 3. 파일명 변조 방지

공격자가 `../../../etc/passwd` 같은 파일명을 사용할 수 없도록 해야 한다.

파일명을 랜덤한 해시값으로 변경하여 저장하는 것도 좋은 방법이 될 수 있다.

```php
$new_filename = uniqid() . '.' . $file_extension;
move_uploaded_file($_FILES['upload']['tmp_name'], "uploads/" . $new_filename);
```

<br>

### 4. 업로드 용량 제한

대량 파일 업로드로 인한 DoS 공격을 방지하기 위해 업로드 크기를 제한해야 한다.

```ini
# php.ini 설정
upload_max_filesize = 2M
post_max_size = 2M
max_file_uploads = 10
```

<br>
<br>

## **공격 시나리오**

### 1. 기본적인 웹쉘 업로드 공격

① 공격자가 악성 PHP 파일을 업로드

```php
// shell.php
<?php system($_GET['cmd']); ?>
```

② 파일이 `http://example.com/uploads/shell.php` 에 저장됨

③ 공격자는 브라우저에서 `http://example.com/uploads/shell.php?cmd=whoami` 실행

④ 서버에서 whoami 명령어가 실행되면서 공격 성공

<br>

### 2. MIME 타입을 우회한 공격

① 공격자가 PHP 코드를 포함한 이미지를 업로드

```php
<?php system($_GET['cmd']); ?>
```

이 파일을 `image.php.jpg`로 저장

② Burp Suite 같은 프록시 툴을 사용해 `Content-Type: image/png`으로 변경 후 업로드

③ 서버가 MIME 타입만 검사하면 업로드 성공

④ 공격자는 `image.php.jpg`를 실행해 서버에서 명령어를 실행

<br>

### 3. 디렉터리 트래버설을 이용한 공격

① 공격자가 파일명을 `../../../var/www/html/shell.php`로 설정

② 업로드 기능이 경로 검증을 하지 않으면, `shell.php`가 서버의 중요한 경로에 저장됨

③ 공격자가 웹 브라우저에서 실행하여 서버 장악
